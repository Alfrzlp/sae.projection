---
title: "projection_xgboost"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{projection_xgboost}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## **Introduction**

This vignette demonstrates how to use the **projection_xgboost()** function from the **sae.projection** package to perform small area estimation using the XGBoost algorithm. The function is designed to support both regression and classification tasks, and is particularly useful for generating estimates in smaller domains (e.g., districts or regencies) based on models trained from larger domains (e.g., provinces).

Key features of the function include:

-   **Feature selection** (`feature_selection = TRUE/FALSE`)\
    Allows automatic selection of the most relevant predictors during model training. This step can help reduce overfitting and improve predictive performance. It can be enabled or disabled as needed.

-   **Bias correction** (`bias_correction = TRUE/FALSE`) Applies a post-estimation adjustment to reduce systematic differences between model-based estimates and direct survey estimates. Especially useful in small area estimation scenarios.

-   **Flexible sample design**\
    The function supports both **simple random sampling (SRS)** and **complex survey designs**, including multi-stage and stratified designs:

    -   For **one-stage designs**, specify the primary sampling unit (PSU) with `id = "psu"`.

    -   For **two-stage designs**, use `id = "psu+ssu"`, where SSU is the secondary sampling unit.

    -   For **three-stage designs**, extend further with `id = "psu+ssu+usu"`.

    -   If your design is stratified, provide the variable name for stratification using the `strata` parameter. Do **not** leave it as `NULL` in that case.

**Important Notes** :

-   Before using the function, **ensure that the input datasets only contain relevant variables**. Any variables that are not used for modeling—such as IDs or administrative codes (e.g., id_ind)—should be removed beforehand.

-   The function **does not support character-based categorical variables** (e.g., `"SD"`, `"SMP"`, `"SMA"`). Users must **preprocess these variables** before modeling, such as by:

    -   Converting them to numeric codes using `as.numeric(factor(...))`, or

    -   Applying one-hot encoding if appropriate.

    Failing to preprocess such variables may lead to errors or unexpected behavior during model training.

**Example Usage**

In the following example, we apply the function to two synthetic datasets:

-   `df_svy_A`: A survey dataset from a higher-level domain (e.g., provinces), used for model training.

-   `df_svy_B`: A dataset from a lower-level domain (e.g., regencies/districts), where predictions will be generated.

## Load package and data

```{r setup}
library(sae.projection)
data(df_svy_A)
data(df_svy_B)

# Remove unused identifier column
df_svy_A <- df_svy_A |> dplyr::select(-id_ind)
df_svy_B <- df_svy_B |> dplyr::select(-id_ind)
```

## Run projection_xgboost

Steps to Fill the **`projection_xgboost()`** Function Arguments

1.   **target_col**\
    Provide the name of the target variable as a character string. For classification tasks, the target should be an integer-encoded class label. For regression, it should be numeric.

2.   **data_model**\
    This is the dataset used for model training, typically from a higher-level domain. It must be cleaned and preprocessed, with irrelevant variables (such as identifiers) removed. Character-type categorical variables should be converted to numeric or dummy variables beforehand.

3.   **data_proj**\
    This is the dataset where predictions will be made, usually from a lower-level domain. It should follow the same structure and preprocessing as the model dataset.

4.   **id**\
    Specify the sampling unit(s) used in the survey design. This could refer to a single-stage or multi-stage unit (e.g., PSU, SSU). For simple random sampling, a general numeric ID can be used.

5.   **STRATA**\
    If the survey design includes stratification, provide the name of the stratification variable. If stratification is not used, this should be set to NULL.

6.   **domain1 and domain2**\
    These define the hierarchical structure of the domains. `domain1` refers to the higher-level area (e.g., province), and `domain2` refers to the lower-level area (e.g., district or regency) where projections will be generated.

7.   **weight**\
    Provide the name of the column containing the sampling weights. This column must exist in both the model and projection datasets.

8.   **nfold**\
    Specify the number of folds for cross-validation during model training. This helps with hyperparameter tuning and model evaluation.

9.   **test_size**\
    Determine the proportion of the model dataset that will be used as a test set for validation purposes.

10.  **task_type**\
    Indicate whether the task is a classification or regression problem. Valid values are `"classification"` and `"regression"`.

11.  **feature_selection**\
    Set this to `TRUE` to enable automatic selection of the most relevant predictors. This helps reduce overfitting and improves generalization.

12.  **corrected_bias**\
    Set this to `TRUE` if you want to apply a post-estimation bias correction to the model predictions, reducing the gap between model-based and direct estimates.

```{r}
result <- projection_xgboost(
                target_col = "Y",
                data_model = df_svy_A,
                data_proj = df_svy_B,
                id = "num",
                STRATA = NULL,
                domain1 = "province",
                domain2 = "regency",
                weight = "weight",
                nfold = 10,
                test_size = 0.2 ,
                task_type = "classification",
                feature_selection = TRUE,
                corrected_bias = TRUE)
print(result)
```
